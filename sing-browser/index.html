<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SingB: Browser-based Read Mapping Tool</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 2rem;
            position: relative;
        }
        h1 {
            color: #0f172a;
            margin-bottom: 1rem;
            font-size: 2.5rem;
            font-weight: 700;
        }
        .privacy-notice {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 2rem;
            text-align: center;
            max-width: 600px;
            line-height: 1.5;
        }
        .container {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            width: 100%;
            max-width: 1800px;
            margin-bottom: 3rem;
        }
        footer {
            margin-top: auto;
            color: #94a3b8;
            font-size: 0.875rem;
            padding: 1rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .inline-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #334155;
        }
        input[type="file"] {
            display: block;
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: #f1f5f9;
            color: #475569;
            cursor: pointer;
        }
        input[type="file"]::file-selector-button {
            margin-right: 1rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            background-color: #e2e8f0;
            color: #475569;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #cbd5e1;
        }
        button {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            background-color: var(--primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        button:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }
        button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }
        #status {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #1e293b;
            color: #e2e8f0;
            border-radius: 6px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        .stats-box {
            font-size: 1.25rem;
            color: #0f172a;
            line-height: 1.45;
            margin-bottom: 1rem;
            background: linear-gradient(180deg, #ffffff, #fbfdff);
            padding: 1rem 1.25rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 6px 18px rgba(16,24,40,0.06);
            white-space: pre-wrap;
            font-weight: 600;
        }
        #device-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        #device-info strong {
            font-weight: 700;
        }
        #performance-metrics {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            font-family: ui-monospace, monospace;
            font-size: 0.875rem;
            line-height: 1.8;
        }
        #performance-metrics .metric-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        #performance-metrics .metric-label {
            opacity: 0.9;
        }
        #performance-metrics .metric-value {
            font-weight: 700;
        }
        /* Mobile responsive */
        @media (max-width: 768px) {
            body { padding: 0.75rem; }
            h1 { font-size: 1.4rem; margin-bottom: 0.5rem; }
            .privacy-notice { font-size: 0.8rem; margin-bottom: 1rem; max-width: 100%; }
            .container { padding: 1rem; max-width: 100%; }
            #device-info { font-size: 0.75rem; padding: 0.75rem; }
            #performance-metrics { font-size: 0.75rem; }
            .stats-box { font-size: 1rem; padding: 0.75rem; }
            button { padding: 1rem; font-size: 1.1rem; -webkit-tap-highlight-color: transparent; }
            input[type="file"] { font-size: 0.85rem; padding: 0.75rem; }
            .inline-group { gap: 0.5rem; }
            .form-group { margin-bottom: 1rem; }
            label { font-size: 0.9rem; }
            footer { font-size: 0.75rem; }
        }
    </style>
</head>
<body>
    <h1>SingB: Browser-based Genomic Read Mapping Tool</h1>
    <p class="privacy-notice">Please be aware that, because WebAssembly is used for this process, your data will not be uploaded to an external server. The mapping algorithm will only operate locally.</p>
    
    <div id="device-info" style="max-width: 1800px; width: 100%;"></div>
    
    <div class="container">
        <div class="form-group">
            <label>Input Mode</label>
            <div class="inline-group">
                <label class="inline-group"><input type="radio" name="mode" value="se" checked style="margin-right: 0.5rem;">Single-End</label>
                <label class="inline-group"><input type="radio" name="mode" value="pe" style="margin-right: 0.5rem;">Paired-End</label>
            </div>
        </div>

        <div class="form-group">
            <label for="ref-file">Reference (FASTA)</label>
            <input type="file" id="ref-file" accept=".fa,.fna,.fasta,.fa.gz,.fna.gz,.fasta.gz">
            <div style="font-size: 0.8em; color: #64748b; margin-top: 0.25rem;">Supported formats: .fa, .fna, .fasta</div>
        </div>
        
        <div class="form-group">
            <label for="reads1-file">Read 1 (FASTQ)</label>
            <input type="file" id="reads1-file" accept=".fq,.fastq,.fq.gz,.fastq.gz">
            <div style="font-size: 0.8em; color: #64748b; margin-top: 0.25rem;">Supported formats: .fq, .fastq (optionally gzipped)</div>
        </div>

        <div class="form-group" id="reads2-group" style="display: none;">
            <label for="reads2-file">Read 2 (FASTQ)</label>
            <input type="file" id="reads2-file" accept=".fq,.fastq,.fq.gz,.fastq.gz">
            <div style="font-size: 0.8em; color: #64748b; margin-top: 0.25rem;">Shown only in paired-end mode</div>
        </div>

        <div class="form-group">
            <label class="inline-group" style="margin-bottom: 0;">
                <input type="checkbox" id="sort-checkbox" style="margin-right: 0.5rem;"> Coordinate Sort (high memory)
            </label>
            <div style="font-size: 0.8em; color: #64748b; margin-top: 0.25rem;">Enable to buffer and sort alignments before download.</div>
        </div>

        <div class="form-group">
            <label for="format-select">Output Format</label>
            <select id="format-select" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
                <option value="bam" selected>BAM</option>
                <option value="sam">SAM</option>
            </select>
        </div>

        <button id="run-btn" disabled>Run Mapping</button>
        
        <div id="progress-container" style="display: none; margin-top: 1rem; width: 100%; height: 1.5rem; background-color: #e2e8f0; border-radius: 999px; overflow: hidden;">
            <div id="progress-bar" style="width: 0%; height: 100%; background-color: var(--primary); transition: width 0.3s ease;"></div>
        </div>
        
        <div id="performance-metrics">
            <div class="metric-row">
                <span class="metric-label">‚ö° Throughput:</span>
                <span class="metric-value" id="metric-throughput">-- reads/s</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">üíæ Memory:</span>
                <span class="metric-value" id="metric-memory">-- MB</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">üìä Data Rate:</span>
                <span class="metric-value" id="metric-datarate">-- MB/s</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">üìà Peak Memory:</span>
                <span class="metric-value" id="metric-peak">-- MB</span>
            </div>
        </div>
        
        <div id="status"></div>

        <div id="results-area" style="display:none; margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
            <div class="inline-group" style="margin-bottom: 1rem;">
                <button id="btn-download" style="background-color: #10b981;">Download</button>
            </div>
            <div id="stats" class="stats-box" style="display:none;"></div>
            <div id="igv-div" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <footer>
        &copy; 2026 Hyunsu Lim.
    </footer>

    <script type="module">
        const refInput = document.getElementById('ref-file');
        const reads1Input = document.getElementById('reads1-file');
        const reads2Input = document.getElementById('reads2-file');
        const reads2Group = document.getElementById('reads2-group');
        const modeInputs = document.querySelectorAll('input[name="mode"]');
        const sortCheckbox = document.getElementById('sort-checkbox');
        const formatSelect = document.getElementById('format-select');
        const runBtn = document.getElementById('run-btn');
        const statusDiv = document.getElementById('status');
        
        function log(msg) {
            statusDiv.style.display = 'block';
            statusDiv.textContent += msg + '\n';
            statusDiv.scrollTop = statusDiv.scrollHeight;
            console.log(msg);
        }

        let partitionedWorkflow = null;
        let detectDevice = null;
        const engineReady = (async () => {
            try {
                log('Loading mapper engine...');
                const mod = await import('./index.js');
                partitionedWorkflow = mod.partitionedWorkflow;
                detectDevice = mod.detectDevice;
                
                // Display device info
                if (detectDevice) {
                    const device = detectDevice();
                    const deviceInfoDiv = document.getElementById('device-info');
                    deviceInfoDiv.innerHTML = `
                        <strong>üì± Device Profile:</strong> ${device.profile} | 
                        <strong>üíª Memory:</strong> ${device.memory}GB | 
                        <strong>üîß CPU Cores:</strong> ${device.cores} | 
                        <strong>‚öôÔ∏è Optimized Workers:</strong> ${device.recommendedWorkers} | 
                        <strong>üì¶ Chunk Size:</strong> ${(device.recommendedChunkSize / (1024 * 1024)).toFixed(0)}MB
                    `;
                }
                
                log('Mapper engine loaded.');
                return true;
            } catch (err) {
                const msg = err?.message || err;
                log(`Failed to load mapper engine: ${msg}`);
                console.error(err);
                return false;
            }
        })();

        function isPaired() {
            const selected = document.querySelector('input[name="mode"]:checked');
            return selected && selected.value === 'pe';
        }

        function checkInputs() {
            const hasRef = refInput.files.length > 0;
            const hasR1 = reads1Input.files.length > 0;
            const needsR2 = isPaired();
            const hasR2 = reads2Input.files.length > 0;
            runBtn.disabled = !(hasRef && hasR1 && (!needsR2 || hasR2));
        }

        function updateMode() {
            if (isPaired()) {
                reads2Group.style.display = 'block';
            } else {
                reads2Group.style.display = 'none';
            }
            checkInputs();
        }

        refInput.addEventListener('change', checkInputs);
        reads1Input.addEventListener('change', checkInputs);
        reads2Input.addEventListener('change', checkInputs);
        modeInputs.forEach((input) => input.addEventListener('change', updateMode));

        let currentResultBlob = null;

        runBtn.addEventListener('click', async () => {
            runBtn.disabled = true;
            runBtn.textContent = 'Read mapping...';
            statusDiv.textContent = '';
            document.getElementById('results-area').style.display = 'none';
            document.getElementById('igv-div').innerHTML = '';
            currentResultBlob = null;

            const ready = await engineReady;
            if (!ready || !partitionedWorkflow) {
                log('Engine failed to load. Please reload and try again.');
                runBtn.disabled = false;
                runBtn.textContent = 'Run Mapping';
                return;
            }

            log('Starting workflow...');
            
            try {
                const refFile = refInput.files[0];
                const readsFile = reads1Input.files[0];
                const reads2File = isPaired() ? reads2Input.files[0] : undefined;
                const sortOutput = sortCheckbox.checked;
                const outputFormat = formatSelect.value;
                
                log(`Reference: ${refFile.name} (${(refFile.size / 1024 / 1024).toFixed(2)} MB)`);
                log(`Mode: ${isPaired() ? 'Paired-End' : 'Single-End'}`);
                log(`Read 1: ${readsFile.name} (${(readsFile.size / 1024 / 1024).toFixed(2)} MB)`);
                if (reads2File) {
                    log(`Read 2: ${reads2File.name} (${(reads2File.size / 1024 / 1024).toFixed(2)} MB)`);
                }
                log(`Sorting: ${sortOutput ? 'Enabled' : 'Disabled'}`);
                
                let effectiveFormat = outputFormat;
                let effectiveChunkSize = undefined; // let workflow auto-detect based on device

                if (outputFormat === 'bam') {
                    const totalSize = readsFile.size + (reads2File ? reads2File.size : 0);
                    const BAM_LIMIT = 100 * 1024 * 1024;

                    if (totalSize < BAM_LIMIT) {
                        effectiveChunkSize = totalSize + 1024;
                        log(`Small input detected. Using single-pass for valid BAM generation.`);
                    }
                }

                log(`Output format: ${effectiveFormat.toUpperCase()}`);

                const progressContainer = document.getElementById('progress-container');
                const progressBar = document.getElementById('progress-bar');
                const perfMetrics = document.getElementById('performance-metrics');
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                perfMetrics.style.display = 'block';

                 const result = await partitionedWorkflow(
                     refFile, 
                     readsFile, 
                     reads2File, 
                     sortOutput, 
                     effectiveFormat, 
                     effectiveChunkSize, 
                     log, 
                     (percent) => {
                         progressBar.style.width = percent + '%';
                     },
                     (metrics) => {
                         // Update real-time performance metrics
                         document.getElementById('metric-throughput').textContent = 
                             `${metrics.currentReadsPerSec.toLocaleString()} reads/s (avg: ${metrics.avgReadsPerSec.toLocaleString()})`;
                         document.getElementById('metric-memory').textContent = 
                             `${metrics.currentMemoryMB} MB`;
                         document.getElementById('metric-datarate').textContent = 
                             `${metrics.currentMbPerSec} MB/s (avg: ${metrics.avgMbPerSec})`;
                         document.getElementById('metric-peak').textContent = 
                             `${metrics.peakMemoryMB} MB`;
                     }
                );
                
                 currentResultBlob = result.blob;
                 const stats = result.stats || {};
                 const total = stats.total ?? 0;
                 const mapped = stats.mapped ?? 0;
                 const mappedBases = stats.mappedBases ?? 0;
                 const genomeSize = stats.genomeSize ?? 0;
                 const avgCoverage = stats.avgCoverage ?? 0;
                 const mapRate = total > 0 ? (mapped / total * 100) : 0;

                                 const statsDiv = document.getElementById('stats');
                                 statsDiv.style.display = 'block';
                                 statsDiv.innerHTML = `
                                        <div style="display:flex;gap:1.25rem;align-items:baseline;flex-wrap:wrap;">
                                            <div style="font-size:1.6rem;color:#0f172a;">${mapped.toLocaleString()}</div>
                                            <div style="color:#64748b;font-size:0.95rem;">mapped / ${total.toLocaleString()} total reads</div>
                                        </div>
                                        <div style="margin-top:0.5rem;display:flex;gap:1rem;flex-wrap:wrap;">
                                            <div style="background:#eef2ff;padding:0.45rem 0.75rem;border-radius:6px;font-weight:700;color:#4338ca;">Mapping Ratio: ${mapRate.toFixed(2)}%</div>
                                            <div style="background:#ecfdf5;padding:0.45rem 0.75rem;border-radius:6px;font-weight:700;color:#065f46;">Mean Coverage: ${avgCoverage.toFixed(4)}</div>
                                            ${genomeSize > 0 ? `<div style="background:#fff7ed;padding:0.45rem 0.75rem;border-radius:6px;font-weight:700;color:#92400e;">Genome Size: ${genomeSize.toLocaleString()}</div>` : ''}
                                        </div>
                                 `;
                
                log(`Done! Results ready.`);
                document.getElementById('results-area').style.display = 'block';

                document.getElementById('btn-download').onclick = () => {
                    const url = URL.createObjectURL(currentResultBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `sing-browser-output.${effectiveFormat}`;
                    a.click();
                    setTimeout(() => URL.revokeObjectURL(url), 10000);
                };

            } catch (e) {
                const msg = e.message || e;
                log(`Error: ${msg}`);
                console.error(e);
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = 'Run Mapping';
            }
        });

        updateMode();
    </script>
</body>
</html>
